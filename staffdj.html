<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff â€“ Ritmo Latinos Colombia Radio Chat</title>
  <link rel="icon" href="img/LogoRL.jpg" type="image/jpeg" />

  <style>
    /* ===== Estilos generales ===== */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0c10;
      color: #fff;
    }

    h1 {
      text-align: center;
      padding: 20px 0;
      font-size: 2.2rem;
      color: #ffcc00;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ===== Grid de tarjetas ===== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    /* ===== Tarjeta del staff ===== */
    .card {
      background: #1f2833;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      transition: 0.3s;
    }

    .card:hover {
      transform: scale(1.03);
    }

    .card-img {
      height: 180px;
      background: #4b4c63;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: #ccc;
      background-size: cover;
      background-position: center;
    }

    .info {
      padding: 15px;
      text-align: center;
    }

    .info h3 {
      margin: 10px 0;
      font-size: 1.4rem;
      color: #66fcf1;
    }

    .info p {
      font-size: 0.9rem;
      color: #c5c6c7;
    }

    /* ===== BotÃ³n de Me gusta ===== */
    .stats {
      display: flex;
      justify-content: center;
      background: #0b0c10;
      padding: 10px 0;
      margin-top: 10px;
    }

    .like-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      background: #66fcf1;
      color: #0b0c10;
      border: none;
      border-radius: 5px;
      padding: 5px 15px;
      font-size: 1rem;
      transition: 0.2s;
    }

    .like-btn:hover {
      background: #45a29e;
    }

    .like-btn.disabled {
      background: gray;
      cursor: not-allowed;
      opacity: 0.8;
    }

    /* ===== BotÃ³n de regreso ===== */
    .back {
      text-align: center;
      margin-top: 30px;
    }

    .back a {
      color: #66fcf1;
      text-decoration: none;
      font-size: 1.2rem;
    }

    /* Mensajes de estado */
    .status {
      text-align: center;
      margin-top: 12px;
      color: #c5c6c7;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>
  <h1>ğŸ’« Nuestro Staff ğŸ’«</h1>

  <div class="container">
    <div class="grid" id="staff-grid">

      <!-- --- (Mantengo tus 20 tarjetas exactamente como en el original) --- -->

      <!-- Tarjeta 1 -->
      <div class="card" data-id="1">
        <div class="card-img" style="background-image: url('img/Djatomico.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ Founder, DJ Atomico</h3>
          <p>CumpleaÃ±os: 30/12.</p>
          <p>Signo: Capricornio.</p>
          <p>Virtudes: Ser el Big Boss.</p>
          <p>Programa: Llena tu cabeza de rock.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <!-- Tarjeta 2 -->
      <div class="card" data-id="2">
        <div class="card-img" style="background-image: url('img/DjMariobros.png');"></div>
        <div class="info">
          <h3>ğŸ§ CoFounder, DJ MarioBros</h3>
          <p>CumpleaÃ±os: 12/02.</p>
          <p>Signo: Acuario.</p>
          <p>Virtudes: Hacer el bien, sin mirar a quien.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <!-- Tarjeta 3 -->
      <div class="card" data-id="3">
        <div class="card-img" style="background-image: url('img/DjCucarachita.png');"></div>
        <div class="info">
          <h3>ğŸ§ Admin, DJ CucarachitaPR</h3>
          <p>CumpleaÃ±os: 23/12.</p>
          <p>Signo: Carpicornio.</p>
          <p>Virtudes: Honesta, simpÃ¡tica, empÃ¡tica.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <!-- Tarjeta 4 -->
      <div class="card" data-id="4">
        <div class="card-img" style="background-image: url('img/DjRomi.png');"></div>
        <div class="info">
          <h3>ğŸ§ Admin, DJ RoMi</h3>
          <p>CumpleaÃ±os: 10/09.</p>
          <p>Signo: Virgo.</p>
          <p>Virtudes: Empatica, sincera y critica.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <!-- Tarjeta 5 -->
      <div class="card" data-id="5">
        <div class="card-img" style="background-image: url('img/Djbrandy.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ BrAnDy</h3>
          <p>CumpleaÃ±os: 21/01.</p>
          <p>Signo: Acuario.</p>
          <p>Virtudes: Servicial, independiente y visionaria.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <!-- Tarjetas 6 a 20 (mismo contenido que el original) -->
      <div class="card" data-id="6">
        <div class="card-img" style="background-image: url('img/papasfritas.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Papas_fritas</h3>
          <p>CumpleaÃ±os: 30/01.</p>
          <p>Signo: Acuario.</p>
          <p>Virtudes: Paciencia, templanza, perseverancia.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="7">
        <div class="card-img" style="background-image: url('img/shaplin.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Shaplin</h3>
          <p>CumpleaÃ±os: 30/01.</p>
          <p>Signo: Acuario.</p>
          <p>Virtudes: Respetuoso. introvertido y carismatico.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="8">
        <div class="card-img" style="background-image: url('img/LogoRL.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Lynda</h3>
          <p>CumpleaÃ±os: 20/04</p>
          <p>Signo: Aries.</p>
          <p>Virtudes: Sincera, tierna y roamntica.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="9">
        <div class="card-img" style="background-image: url('img/cuervo.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Cuervo</h3>
          <p>CumpleaÃ±os: 24/04.</p>
          <p>Signo: Tauro.</p>
          <p>Virtudes: Escuchar, paciente y tolerante.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="10">
        <div class="card-img" style="background-image: url('img/lalala.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ lalala</h3>
          <p>CunpleaÃ±os: 01/06.</p>
          <p>Signo: GÃ©minis.</p>
          <p>Virtudes: Amorosa, sincera y humanitaria.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="11">
        <div class="card-img" style="background-image: url('img/albertdj.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Albertdj</h3>
          <p>CumpleaÃ±os: 16/06.</p>
          <p>Signo: Virgo.</p>
          <p>Virtudes: Simpatico, alegre y optimista..</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="12">
        <div class="card-img" style="background-image: url('img/LogoRL.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ MaRcElO-2180</h3>
          <p>CumpleaÃ±os: 21/09.</p>
          <p>Signo: Virgo.</p>
          <p>Virtudes: Alegre, extrovertido y servicial.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="13">
        <div class="card-img" style="background-image: url('img/andrea.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Andrea</h3>
          <p>CumpleaÃ±os: 01/10.</p>
          <p>Signo: Libra.</p>
          <p>Virtudes: Leal, sincera y sociable.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="14">
        <div class="card-img" style="background-image: url('img/errante.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ ERRANTE_DEL_SOL</h3>
          <p>CumpleaÃ±os: 06/12.</p>
          <p>Signo: Sagitario.</p>
          <p>Virtudes: Amistoso, respetuoso y simpatico.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="15">
        <div class="card-img" style="background-image: url('img/xaxixax.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ XAXIXAX</h3>
          <p>CumpleaÃ±os: 07/12.</p>
          <p>Signo: Sagitario.</p>
          <p>Virtudes: Divertido, chukuLaterooo, amable y respetuoso.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="16">
        <div class="card-img" style="background-image: url('img/pompompuri.png');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Pompompuri</h3>
          <p>CumpleaÃ±os: 11/12.</p>
          <p>Signo: Sagitario.</p>
          <p>Virtudes: Cautivador, seductor y arriesgado.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="17">
        <div class="card-img" style="background-image: url('img/kalanys.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Kalanys</h3>
          <p>CumpleaÃ±os: 17/12.</p>
          <p>signo: Sagitario.</p>
          <p>Virtudes: Leal, creativa y alegre.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="18">
        <div class="card-img" style="background-image: url('img/valquiria.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Valquiria</h3>
          <p>CumpleaÃ±os: 17/12.</p>
          <p>Signo: Sagitario.</p>
          <p>Virtudes: EmpÃ¡tica, resiliente y aguerrida.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="19">
        <div class="card-img" style="background-image: url('img/LogoRL.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Nuevo 19</h3>
          <p>DescripciÃ³n del integrante.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

      <div class="card" data-id="20">
        <div class="card-img" style="background-image: url('img/LogoRL.jpg');"></div>
        <div class="info">
          <h3>ğŸ§ DJ Nuevo 20</h3>
          <p>DescripciÃ³n del integrante.</p>
          <div class="stats">
            <button class="like-btn"><span class="like-emoji">ğŸ‘</span> <span class="like-count">0</span></button>
          </div>
        </div>
      </div>

    </div> <!-- Cierre grid -->

    <div class="back">
      <a href="index.html">â† Volver al inicio</a>
    </div>

    <div class="status" id="global-status">Cargando datos...</div>
  </div> <!-- Cierre container -->

  <script>
/*
  Sistema de likes con bloqueo por fingerprint (IP + userAgent -> SHA-256)
  - Hoja principal (SheetDB): columnas ID, NOMBRE, LIKES
  - Hoja votes (SheetDB): columnas STAFF_ID, FINGERPRINT
  - SheetDB endpoint: https://sheetdb.io/api/v1/12c925tu2uzxh
  - AutenticaciÃ³n Basic (username / password) incluida
*/

const API_URL = 'https://sheetdb.io/api/v1/12c925tu2uzxh';
const VOTES_SHEET_QUERY = API_URL + '?sheet=votes';
const username = 'szno87wn';
const password = '9o5qxrvjl7n7ucm4wfec';

// Headers para todas las peticiones
const headers = new Headers();
headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
headers.set('Content-Type', 'application/json');

// Estado global
let FINGERPRINT = null;
const STATUS_EL = document.getElementById('global-status');

// -----------------------------
// UTIL: obtener IP pÃºblica
// -----------------------------
async function fetchPublicIP() {
  try {
    const r = await fetch('https://api64.ipify.org?format=json');
    const j = await r.json();
    return j.ip || '0.0.0.0';
  } catch (e) {
    // Fallback a otra API
    try {
      const r = await fetch('https://api.ipify.org?format=json');
      const j = await r.json();
      return j.ip || '0.0.0.0';
    } catch (err) {
      return '0.0.0.0';
    }
  }
}

// -----------------------------
// UTIL: SHA-256 (ArrayBuffer -> hex)
// -----------------------------
async function sha256Hex(message) {
  const enc = new TextEncoder();
  const data = enc.encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

// -----------------------------
// Generar fingerprint Ãºnico
// -----------------------------
async function generateFingerprint() {
  const ip = await fetchPublicIP();
  const ua = navigator.userAgent || 'unknown';
  const raw = `${ip}::${ua}`;
  return await sha256Hex(raw);
}

// -----------------------------
// Cargar likes desde hoja principal
// -----------------------------
async function loadLikesFromSheet() {
  try {
    const res = await fetch(API_URL, { headers });
    if (!res.ok) throw new Error('Error al obtener datos principales');
    const data = await res.json();

    // data es un array de filas; se asume que columna ID coincide con data-id
    document.querySelectorAll('.card').forEach(card => {
      const id = card.dataset.id;
      const entry = data.find(row => String(row.ID) === String(id) || String(row.id) === String(id));
      if (entry) {
        const count = entry.LIKES || entry.likes || 0;
        const span = card.querySelector('.like-count');
        if (span) span.textContent = count;
      }
    });
    STATUS_EL.textContent = 'Datos cargados.';
  } catch (err) {
    console.error('loadLikesFromSheet:', err);
    STATUS_EL.textContent = 'No se pudo cargar likes (ver consola).';
  }
}

// -----------------------------
// Verificar si existe voto para staffId + fingerprint en la hoja votes
// -----------------------------
async function checkVoteExists(staffId, fingerprint) {
  try {
    // Construimos query con nombre exacto de columnas: STAFF_ID y FINGERPRINT
    const url = `${VOTES_SHEET_QUERY}&STAFF_ID=${encodeURIComponent(staffId)}&FINGERPRINT=${encodeURIComponent(fingerprint)}`;
    const res = await fetch(url, { headers });
    if (!res.ok) return false;
    const data = await res.json();
    return Array.isArray(data) && data.length > 0;
  } catch (err) {
    console.error('checkVoteExists error:', err);
    // En caso de error conservador: devuelve false (permitir voto localmente),
    // pero el botÃ³n serÃ¡ protegido por localStorage adicional.
    return false;
  }
}

// -----------------------------
// Registrar voto en hoja votes
// -----------------------------
async function postVoteRecord(staffId, fingerprint) {
  try {
    // SheetDB acepta { data: { ... } }
    const body = JSON.stringify({
      data: {
        STAFF_ID: staffId,
        FINGERPRINT: fingerprint,
        TIMESTAMP: new Date().toISOString()
      }
    });

    const res = await fetch(VOTES_SHEET_QUERY, {
      method: 'POST',
      headers,
      body
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error('postVoteRecord fallo: ' + text);
    }

    return true;
  } catch (err) {
    console.error('postVoteRecord error:', err);
    return false;
  }
}

// -----------------------------
// Actualizar campo LIKES en hoja principal (por ID)
// -----------------------------
async function patchLikesInMain(staffId, newLikes) {
  try {
    const url = `${API_URL}/ID/${encodeURIComponent(staffId)}`;
    const body = JSON.stringify({ data: { LIKES: newLikes } });

    const res = await fetch(url, {
      method: 'PATCH',
      headers,
      body
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error('patchLikesInMain fallo: ' + text);
    }
    return true;
  } catch (err) {
    console.error('patchLikesInMain error:', err);
    return false;
  }
}

// -----------------------------
// Manejo de eventos en botones
// -----------------------------
function attachEventsToButtons() {
  document.querySelectorAll('.card').forEach(card => {
    const btn = card.querySelector('.like-btn');
    const span = card.querySelector('.like-count');
    const staffId = card.dataset.id;

    if (!btn) return;

    // Estado inicial: disable si localStorage tiene marca (segunda capa)
    const localKey = `liked_staff_${staffId}`;
    if (localStorage.getItem(localKey) === '1') {
      btn.classList.add('disabled');
      btn.textContent = 'Ya votaste';
      return;
    }

    // Click handler
    btn.addEventListener('click', async function handler(e) {
      // Desactivar doble-click mientras procesamos
      btn.disabled = true;
      btn.classList.add('disabled');

      // Pre-check: si localStorage marcado (capa local) bloquear
      if (localStorage.getItem(localKey) === '1') {
        btn.textContent = 'Ya votaste';
        return;
      }

      // 1) Verificar en hoja votes si ya existe el voto
      let already = false;
      try {
        already = await checkVoteExists(staffId, FINGERPRINT);
      } catch (err) {
        console.error('Error verificando voto existente:', err);
        // proceed conservatively (we allowed to continue)
      }

      if (already) {
        btn.textContent = 'Ya votaste';
        localStorage.setItem(localKey, '1');
        return;
      }

      // 2) Incrementar contador visual
      const current = parseInt(span.textContent) || 0;
      const newCount = current + 1;
      span.textContent = newCount;

      // 3) Registrar en hoja votes y en hoja principal
      const posted = await postVoteRecord(staffId, FINGERPRINT);
      if (!posted) {
        // Si no se guardÃ³ el registro de vote, revertimos contador visual y re-habilitamos botÃ³n
        span.textContent = current;
        btn.disabled = false;
        btn.classList.remove('disabled');
        STATUS_EL.textContent = 'Error registrando voto. Intenta de nuevo.';
        return;
      }

      const patched = await patchLikesInMain(staffId, newCount);
      if (!patched) {
        // Si no se actualizÃ³ LIKES en main, esto no elimina el registro en votes (podrÃ­as corregir manualmente).
        STATUS_EL.textContent = 'Voto registrado, pero no se actualizÃ³ contador principal (ver consola).';
      } else {
        STATUS_EL.textContent = 'Gracias por votar.';
      }

      // 4) Marcar en localStorage para bloquear en el mismo navegador
      localStorage.setItem(localKey, '1');

      // 5) Cambiar texto del botÃ³n
      btn.textContent = 'Gracias por votar';
    });
  });
}

// -----------------------------
// InicializaciÃ³n principal
// -----------------------------
(async function init() {
  try {
    STATUS_EL.textContent = 'Generando fingerprint...';
    FINGERPRINT = await generateFingerprint();

    STATUS_EL.textContent = 'Cargando likes desde SheetDB...';
    await loadLikesFromSheet();

    STATUS_EL.textContent = 'Verificando votos locales y del servidor...';

    // Para cada tarjeta, comprobamos en la hoja votes si ya votÃ³ y deshabilitamos el botÃ³n si corresponde.
    const cards = Array.from(document.querySelectorAll('.card'));
    await Promise.all(cards.map(async (card) => {
      const staffId = card.dataset.id;
      const btn = card.querySelector('.like-btn');
      const localKey = `liked_staff_${staffId}`;

      // Si localStorage ya indica voto, deshabilitar inmediatamente
      if (localStorage.getItem(localKey) === '1') {
        if (btn) {
          btn.classList.add('disabled');
          btn.textContent = 'Ya votaste';
        }
        return;
      }

      // Si no, consultamos la hoja votes
      const exists = await checkVoteExists(staffId, FINGERPRINT);
      if (exists) {
        // Marcar localmente para futuras visitas
        localStorage.setItem(localKey, '1');
        if (btn) {
          btn.classList.add('disabled');
          btn.textContent = 'Ya votaste';
        }
      }
    }));

    // Finalmente, asociamos manejadores a los botones
    attachEventsToButtons();

    STATUS_EL.textContent = 'Listo.';
  } catch (err) {
    console.error('InicializaciÃ³n error:', err);
    STATUS_EL.textContent = 'Error durante la inicializaciÃ³n (ver consola).';
    // Aun asÃ­ attach events para permitir pruebas locales
    attachEventsToButtons();
  }
})();
  </script>

</body>
</html>
